name: Release Branch Automation

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize]

jobs:
  process-release-branch:
    if: startsWith(github.head_ref, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Extract version from branch name
        id: extract_version
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          VERSION=${BRANCH_NAME#release/}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Extracted version: $VERSION"
      
      - name: Update version in package.json
        run: |
          npm version ${{ env.VERSION }} --no-git-tag-version
          echo "Updated package.json version to ${{ env.VERSION }}"
      
      - name: Run tests with coverage
        id: test
        run: npm run test:coverage
        continue-on-error: true
      
      - name: Build project
        run: npm run build
      
      - name: Generate test summary
        id: test_summary
        run: |
          # Install jq if needed
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          
          echo "## Test Results" > test-summary.md
          
          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "✅ All tests passed successfully!" >> test-summary.md
          else
            echo "❌ Tests failed! Please check the logs for details." >> test-summary.md
          fi
          
          echo "" >> test-summary.md
          
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "## Code Coverage Summary" >> test-summary.md
            echo '```json' >> test-summary.md
            cat coverage/coverage-summary.json >> test-summary.md
            echo '```' >> test-summary.md
            
            # Extract and format coverage metrics for better readability
            echo "" >> test-summary.md
            echo "### Coverage Metrics" >> test-summary.md
            echo "" >> test-summary.md
            
            # Extract total coverage percentages
            STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
            LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            
            echo "| Metric | Coverage |" >> test-summary.md
            echo "| ------ | -------- |" >> test-summary.md
            echo "| Statements | ${STATEMENTS}% |" >> test-summary.md
            echo "| Branches | ${BRANCHES}% |" >> test-summary.md
            echo "| Functions | ${FUNCTIONS}% |" >> test-summary.md
            echo "| Lines | ${LINES}% |" >> test-summary.md
          else
            echo "## Code Coverage" >> test-summary.md
            echo "No coverage report generated due to test failures or configuration issues." >> test-summary.md
            
            # Check if coverage directory exists
            if [ -d "coverage" ]; then
              echo "" >> test-summary.md
              echo "Coverage directory exists but no coverage-summary.json file was found." >> test-summary.md
              echo "Available files in coverage directory:" >> test-summary.md
              echo '```' >> test-summary.md
              ls -la coverage/ >> test-summary.md
              echo '```' >> test-summary.md
            else
              echo "" >> test-summary.md
              echo "Coverage directory was not created. This might indicate a configuration issue." >> test-summary.md
            fi
          fi
          
      - name: Add test results to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-results
          path: test-summary.md
      
      - name: Commit changes
        if: steps.test.outcome == 'success'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json package-lock.json dist/
          git commit -m "chore: bump version to ${{ env.VERSION }} and update build"
          git push
          
      - name: Fail workflow if tests failed
        if: steps.test.outcome != 'success'
        run: |
          echo "Tests failed! Not committing changes."
          exit 1 